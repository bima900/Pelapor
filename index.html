const SPREADSHEET_ID = 'GANTI_DENGAN_ID_SPREADSHEET_ANDA'; // Opsional, tapi lebih aman
const SHEET_NAME_LAPORAN = "Laporan";
const SHEET_NAME_TANGGAPAN = "Tanggapan"; 

function getSpreadsheet() {
  // Jika SPREADSHEET_ID disetel, gunakan itu. Jika tidak, gunakan spreadsheet yang terikat.
  if (SPREADSHEET_ID && SPREADSHEET_ID !== 'GANTI_DENGAN_ID_SPREADSHEET_ANDA') {
    return SpreadsheetApp.openById(SPREADSHEET_ID);
  }
  return SpreadsheetApp.getActiveSpreadsheet();
}

/**
 * doPOST: Menerima laporan dari frontend dan menyimpannya ke Sheet Laporan.
 */
function doPost(e) {
  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME_LAPORAN);
    
    if (!sheet) {
      return responseJson({ status: "error", message: `Sheet '${SHEET_NAME_LAPORAN}' tidak ditemukan.` });
    }

    // Pastikan data diterima sebagai JSON
    const data = JSON.parse(e.postData.contents);
    
    // Asumsi nama field di HTML/payload sama: nama, kategori, isi, lokasi
    const rowData = [
      new Date(),               // Timestamp
      data.nama,                // Nama Pelapor
      data.kategori,            // Kategori Masalah
      data.isi,                 // Isi Laporan
      data.lokasi               // Lokasi Masalah
    ];

    sheet.appendRow(rowData);

    return responseJson({ 
      status: "success", 
      message: "Laporan berhasil dikirim." 
    });
  } catch (error) {
    // Menangkap error JSON parsing atau error lainnya
    return responseJson({ 
      status: "error", 
      message: "Gagal memproses permintaan POST. Error: " + error.toString() 
    });
  }
}

/**
 * doGet: Mengambil data Tanggapan dari Sheet Tanggapan untuk frontend.
 */
function doGet(e) {
  // Hanya melayani permintaan GET jika ada parameter 'action=get_responses'
  if (e.parameter.action !== 'get_responses') {
     // Ini agar URL Apps Script tidak langsung menampilkan HTML jika diakses tanpa parameter
    return ContentService.createTextOutput("Akses tidak sah.");
  }

  try {
    const ss = getSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME_TANGGAPAN);
    
    if (!sheet) {
      return responseJson({ status: "error", message: `Sheet '${SHEET_NAME_TANGGAPAN}' tidak ditemukan.` });
    }

    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length <= 1) {
      return responseJson({ status: "success", data: [] }); // Tidak ada tanggapan (hanya header)
    }
    
    const headers = values[0];
    const tanggapanData = [];
    
    // Mulai dari baris kedua (index 1) untuk data
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      const record = {};
      for (let j = 0; j < headers.length; j++) {
        // Gunakan header sebagai kunci objek
        record[headers[j]] = row[j]; 
      }
      tanggapanData.push(record);
    }

    // Menggunakan .reverse() untuk menampilkan data terbaru di bagian atas
    return responseJson({ 
      status: "success", 
      data: tanggapanData.reverse()
    });

  } catch (error) {
    return responseJson({ 
      status: "error", 
      message: "Gagal memproses permintaan GET. Error: " + error.toString() 
    });
  }
}

/**
 * Fungsi pembantu untuk mengembalikan respons JSON dengan benar.
 */
function responseJson(obj) {
  // Penting untuk mengatasi masalah CORS/Origin di Google Sites/Browser
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST'
    });
}
